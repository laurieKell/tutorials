---
title: "Atlantic Wide Tropical Tuna Tagging Programme"
author: "Laurence Kell"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: rmarkdown:::html_document
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{kobe}
  \DeclareUnicodeCharacter{00A0}{ }
  %\VignetteEncoding{UTF-8}
bibliography: refs.bib
tags: FLPKG FLR
license: Creative Commons Attribution-ShareAlike 4.0 International
---

```{r, eval=TRUE, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(knitr)

opts_chunk$set(comment=NA, 
               warning=FALSE, 
               message=FALSE, 
               error  =FALSE, 
               echo   =FALSE, 
               fig.width =8, 
               fig.height=4,
               fig.path  ="../tex/hcr-")

iFig=0
iTab=0
```

```{r library}
library(ggplotFL)
library(FLCore)
library(FLife)
library(FLBRP)
library(popbio)
library(numDeriv)
library(reshape2)
library(plyr)
```

```{r ss, eval=!TRUE}
library(r4ss)
ss1=SS_output(dir='/home/laurie/Desktop/kobe/inputs/yft/2016/ss/cluster1')
ss2=SS_output(dir='/home/laurie/Desktop/kobe/inputs/yft/2016/ss/cluster2')
mSS1=as.FLQuant(transform(melt(ss1$M_at_age[,-c(1:2)],id="Year"),
                       year=Year,age=variable,data=value)[,4:6])
mSS2=as.FLQuant(transform(melt(ss2$M_at_age[,-c(1:2)],id="Year"),
                       year=Year,age=variable,data=value)[,4:6])
zSS1=as.FLQuant(transform(melt(ss1$Z_at_age[,-c(1:2)],id="Year"),
                       year=Year,age=variable,data=value)[,4:6])
zSS2=as.FLQuant(transform(melt(ss2$Z_at_age[,-c(1:2)],id="Year"),
                       year=Year,age=variable,data=value)[,4:6])
fSS1=zSS1-mSS1
fSS2=zSS2-mSS2

srSS=rbind(cbind(cluster=1,year=1:75,ss1$sprseries[,c("SPB","Recruits")]),
           cbind(cluster=2,year=1:75,ss2$sprseries[,c("SPB","Recruits")]))
srSS=subset(transform(srSS,year=year+1949),year%in%1970:2014)
names(srSS)[3:4]=c("ssb","rec")
ggplot(transform(srSS,ssb=ssb^.01))+
  geom_point(aes(ssb,rec,col=factor(cluster)))+
  geom_smooth(aes(ssb,rec,col=factor(cluster)),method="loess",span=1)+
  geom_smooth(aes(ssb,rec),method="lm")+
  facet_grid(.~cluster)

recSS=FLQuants(dlply(srSS,.(cluster),with,as.FLQuant(data.frame(year=year-1,data=rec))[,-1]))
ssbSS=FLQuants(dlply(srSS,.(cluster),with,as.FLQuant(data.frame(year=year-1,data=ssb))[,-length(ssb)]))

rm(zSS1,zSS2,ss1,ss2,myreplist)

save(fSS1,fSS2,recSS,ssbSS,file="/home/laurie/Desktop/flr/tutorials/advice_framework/data/ss.RData",compress="xz")
```

```{r init, eval=TRUE}
source('~/Desktop/flr/FLife/R/lh-srr-sv.R')

yft=FLStocks("1"=readVPA2Box("/home/laurie/Desktop/kobe/inputs/yft/2016/vpa/cluster1/yft2016.ctl",minage=0),
             "2"=readVPA2Box("/home/laurie/Desktop/kobe/inputs/yft/2016/vpa/cluster2/yft2016.ctl",minage=0))
load("/home/laurie/Desktop/flr/tutorials/advice_framework/data/abbys.RData")

save(yft,file="/home/laurie/Desktop/flr/tutorials/advice_framework/data/yft.RData",compress="xz")
```


# Objectives

To contribute to food security and economic growth of the Atlantic coastal states by ensuring sustainable management of tropical tuna resources in the Atlantic Ocean.

To provide the best science available for the adoption of Conservation and Management Measures i.e.

+ TACs, Reference Points and Harvest Control Rules for main tropical tuna species,
+ Spatial management measures such as time-are closures
+ FAD moratorium and/or management plans,
+ Development of indicators for neritic tunas

Although fisheries statistics are available for most fleets operating in the Atlantic, they do not provide all the information needed to conduct stock assessments

+ Important biological parameters, such as growth or natural mortality are missing or are largely unknown.
+ As a result, the uncertainty in the stock assessments and the associated risks are high.

A specific objective of the AOTTP is therefore to provide evidence based scientific advice to reduce
risks to the tropical tuna fisheries. This will be achieved through improving estimates of key parameters for stock assessments of growth, natural mortality, movement and stock structure.

## Specific Indicator

Reduction of the uncertainty surrounding the assessment of MSYs

```{r sel, fi.width=8,fig.height=4}
load("/home/laurie/Desktop/flr/tutorials/advice_framework/data/yft.RData")
load("/home/laurie/Desktop/flr/tutorials/advice_framework/data/ss.RData")

sel=rbind(cbind(.id=3,as.data.frame((fSS2%/%fapex(fSS2[-11]))[-11,ac(2001:2014)],drop=T)),
          cbind(.id=4,as.data.frame((fSS2%/%fapex(fSS2[-11]))[-11,ac(2001:2014)],drop=T)),
          ldply(yft,function(x) as.data.frame(catch.sel(x[,ac(2001:2014)]),drop=T)))
sel=subset(sel,age<=6)
sel$method =c("VPA","VPA","SS","SS")[as.numeric(sel$.id)]
sel$cluster=paste("Cluster",c("1","2","1","2"))[as.numeric(sel$.id)]

ggplot(sel)+
  geom_point( aes(age,data))+
  geom_smooth(aes(age,data),span=.2,se=FALSE,method="loess")+
  facet_grid(method~cluster)+
  xlab("Age")+ylab("Selection-at-age")+
  theme_bw()+theme(legend.position="none")
```

```{r}
a=FLQuant(seq(0,8,0.1),dimnames=list(age=1:81))
ggplot(ldply(FLQuants("domed"   =dnormal(a,FLPar(a1=5,sl=2.5,sr=.5  )),
                      "flat"    =dnormal(a,FLPar(a1=5,sl=2.5,sr=5000)),
                      "juvenile"=dnormal(a,FLPar(a1=2,sl=0.5,sr=0.5 ))),
       as.data.frame))+
  geom_line(aes(age,data,col=.id))+
  theme_bw()+theme(legend.position="bottom")
```

```{r}
age=FLQuant(1:6,dimnames=list(age=1:6))

sel.pattern=FLQuants("domed"   =dnormal(age,     FLPar(a1=5,sl=2.5,sr=.5  )),
                     "flat"    =dnormal(age,     FLPar(a1=5,sl=2.5,sr=5000)),
                     "juvenile"=dnormal(age[1:3],FLPar(a1=2,sl=0.5,sr=0.5 )))
sel.pattern=llply(sel.pattern,setPlusGroup,plusgroup=40)
```

```{r,fig.height=6,fig.width=8}
srr=FLSRs("vpa1"=fmle(as.FLSR(yft[[1]],model="bevholt"),control=list(control=FALSE)))
srr[["vpa2"]]=fmle(as.FLSR(yft[[2]],model="bevholt"),control=list(control=FALSE))
srr[["ss1"]] =fmle(FLSR(rec=recSS[[1]],ssb=ssbSS[[1]],model="bevholt"),control=list(control=FALSE))
srr[["ss2"]] =fmle(FLSR(rec=recSS[[2]],ssb=ssbSS[[2]],model="bevholt"),control=list(control=FALSE))

sr=ldply(srr,function(x) model.frame(FLQuants(x,"rec","ssb"),drop=TRUE))
ft=ldply(srr,function(x) model.frame(FLQuants(
                                    hat=predict(x,ssb=FLQuant(0:100)*max(ssb(x))*0.01),
                                    ssb=FLQuant(0:100)*max(ssb(x))*0.01)))

sr$method =c("SS","SS","VPA","VPA")[as.numeric(factor(sr$.id))]
sr$cluster=paste("Cluster",c("1","2","1","2"))[as.numeric(factor(sr$.id))]
ft$method =c("SS","SS","VPA","VPA")[as.numeric(factor(ft$.id))]
ft$cluster=paste("Cluster",c("1","2","1","2"))[as.numeric(factor(ft$.id))]

ggplot(sr)+
  geom_point( aes(ssb,rec))+
  geom_line( aes(ssb,hat),data=ft,col="red")+
  facet_wrap(cluster~method,scale="free")+
  xlab("SSB")+ylab("Recruits")+
  theme_bw()
```


```{r}
load("/home/laurie/Desktop/flr/tutorials/advice_framework/data/abbys.RData")
load("/home/laurie/Desktop/flr/tutorials/advice_framework/data/yft.RData")

yftPar=lhPar(FLPar(abbys[,"yft","mean",drop=TRUE]))
yftEql=lhEql(yftPar,range=c(min=1,max=40,minfbar=1,maxfbar=40,plusgroup=40))
```


```{r}
ggplot(FLQuants(yftEql,"m","mat","catch.wt","catch.sel"))+
  geom_line(aes(age,data))+
  facet_wrap(~qname,scale="free_y")+
  scale_x_continuous(lim=c(1,10))+
  theme_bw()+xlab("Age")+ylab("M-at-age")
```

```{r}
plot(yftEql)+
  theme_bw()
```

```{r}
m=propagate(m(yftEql),2)
m[ac(6:40),,,,,2]=m(yftEql)[ac(1)]
ggplot(m[ac(1:10)])+
  geom_line(aes(age,data,col=factor(iter)))+
  theme_bw()+xlab("Age")+ylab("M-at-age")+
  theme(legend.position="none")
```

```{r}
sel=propagate(catch.sel(yftEql),4)
iter(sel,1)=setPlusGroup(sel.pattern[[1]],40)+setPlusGroup(sel.pattern[[3]],40)/2
iter(sel,2)=setPlusGroup(sel.pattern[[2]],40)+setPlusGroup(sel.pattern[[3]],40)/2
iter(sel,3)=setPlusGroup(sel.pattern[[1]],40)+setPlusGroup(sel.pattern[[3]],40)
iter(sel,4)=setPlusGroup(sel.pattern[[2]],40)+setPlusGroup(sel.pattern[[3]],40)
ggplot(sel[ac(1:10)])+
  geom_line(aes(age,data,col=factor(iter)))+
  theme_bw()+xlab("Age")+ylab("M-at-age")+
  theme(legend.position="none")
```

```{r}
eql=FLBRPs(mlply(data.frame(s=c(0.9,0.75)), function(s,par){
  par["s"]=s
  res=lhEql(par)
  refpts(res)=refpts(res)["msy"]
  res},par=yftPar))

plot(eql)+
  theme_bw()
```

```{r, structuralUncertainty}
vec=list(m=m,sel=sel,s=c(0.9,0.75))

eql=FLBRPs(mlply(expand.grid(m  =1:2,
                             sel=1:4,
                             s  =1:2), function(m,sel,s,par,vec){
            #print(c(m,sel,s))                
            par["s"]=vec[["s"]][s]
            res=lhEql(par,range=c(min=1,max=40,minfbar=1,maxfbar=40,plusgroup=40))
            m(  res)=iter(vec[["m"]],m)
            landings.sel(res)=iter(vec[["sel"]],sel)
            
            res=brp(res)
            refpts(res)=refpts(res)["msy"]
            res},par=yftPar,vec=vec))

plot(eql)+
  theme_bw()+
  theme(legend.position="none")
```

```{r, valueUcertainty}
pms=c("linf","k","lmat","m1")
yftPar[ "s"]=0.9
yftPar["m1"]=0.55

eql=lhEql(yftPar,
          mat  =logistic,
          m    =function(length,params) exp(params["m1"])*(length^-1.61)%*%(params["linf"]^1.44)%*%params["k"],
          range=c(min=1,max=40,minfbar=1,maxfbar=40,plusgroup=40))
msy=computeRefpts(eql)["msy",1:5]

fn=function(x,params){
  params[pms]=x
  params["a50"]=vonB(params=yftPar,length=params["lmat"])
  
  eql=lhEql(params,
            mat  =logistic,
            m    =function(length,params) exp(params["m1"])*(length^-1.61)%*%(params["linf"]^1.44)%*%params["k"],
            range=c(min=1,max=40,minfbar=1,maxfbar=40,plusgroup=40),msy="f0.1")
  eql=brp(eql)
  
  computeRefpts(eql)["msy",1:5]}

jac=jacobian(fn,yftPar[pms,drop=T],params=yftPar)

dimnames(jac)=list(refpt =c("harvest","yield","rec","biomass","ssb"),
                   params=pms)
var=abbys[,"yft","var"]/(abbys[,"yft","n"]-1)


cor=array(0,dim=rep(length(pms),2),dimnames=list(params=pms,params=pms))
diag(cor)=1
var=diag(cor)
var[pms]=(yftPar[pms]*0.3)^2

cov=cor2cov(cor,var)

fnCV=function(ref="biomass",cv=cov,jc=jac){
  hes=jc[ref,]%*%t(jc[ref,])
  dimnames(hes)=list(params=pms,params=pms)
  ((hes*cv)^0.5)/c(msy[,ref])}

rev(sort(diag(fnCV("biomass"))))
rev(sort(diag(fnCV("ssb"))))
rev(sort(diag(fnCV("harvest"))))
rev(sort(diag(fnCV("yield"))))

fnP=function(ref,p,msy,cov,hes=jac[ref,]%*%t(jac[ref,])){
       qnorm(p,msy[,ref],sum(hes*cov)^0.5)/msy[,ref]}

cv2=cov
diag(cv2)=diag(cv2)/4
fnP("biomass",p=.8,msy,cov)
fnP("biomass",p=.8,msy,cv2)
fnP("ssb",    p=.8,msy,cov)
fnP("ssb",    p=.8,msy,cv2)
fnP("harvest",p=.2,msy,cov)
fnP("harvest",p=.2,msy,cv2)
fnP("yield",  p=.2,msy,cov)
fnP("yield",  p=.2,msy,cv2)
```

### Reference points based on uncertainty
```{r, eval=!TRUE}
pms=c("linf","k","t0","a","b","lmat","s","bg")
yftPar["s"]=0.9

eql=lhEql(yftPar,
          mat=logistic,
          range=c(min=1,max=40,minfbar=1,maxfbar=40,plusgroup=40))
msy=computeRefpts(eql)["msy",1:5]

fn=function(x,params){
  params[pms]=x
  params["a50"]=vonB(params=yftPar,length=params["lmat"])
  
  eql=lhEql(params,
            mat=logistic,
            range=c(min=1,max=40,minfbar=1,maxfbar=40,plusgroup=40),msy="f0.1")
  eql=brp(eql)
  
  computeRefpts(eql)["msy",1:5]}

jac=jacobian(fn,yftPar[pms,drop=T],params=yftPar)

dimnames(jac)=list(refpt =c("harvest","yield","rec","biomass","ssb"),
                   params=pms)
var=abbys[,"yft","var"]/(abbys[,"yft","n"]-1)


cor=array(0,dim=rep(length(pms),2),dimnames=list(params=pms,params=pms))
diag(cor)=1
var=diag(cor)
var[pms[pms%in%dimnames(abbys)$params]]=(abbys[,"yft","var"])*.5 #/(abbys[,"yft","n"]-1)
var[pms[!pms%in%dimnames(abbys)$params]]=(yftPar[pms[!pms%in%dimnames(abbys)$params]]*.0)^2

cov=cor2cov(cor,var)

fn=function(ref="biomass",cv=cov,jc=jac){
  hes=jc[ref,]%*%t(jc[ref,])
  dimnames(hes)=list(params=pms,params=pms)
  ((hes*cv)^0.5)/c(msy[,ref])}
rev(sort(diag(fn("biomass"))))
rev(sort(diag(fn("ssb"))))
rev(sort(diag(fn("harvest"))))
rev(sort(diag(fn("yield"))))

ref="harvest"
hes=jac[ref,]%*%t(jac[ref,])
qnorm(0.20,msy[,ref],sum(hes[-c(3,5),-c(3,5)]*cov[-c(3,5),-c(3,5)])^0.5)/msy[,ref]
```

```{r kpp1}
```


# Excercise

Based on shiny apps

## 


# References

<!-- pb=FLBRP(ple4) -->
<!-- pb=propagate(FLBRP(ple4),2) -->
<!-- params(pb)=propagate(params(pb),2) -->
<!-- params(pb)["a"]=2 -->
<!-- pb=brp(pb) -->
<!-- plot(pb) -->

