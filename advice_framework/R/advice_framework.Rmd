---
title: "DG-MARE course on assessment & advice in (tuna) RFMOs"
author: "Laurence Kell & Niels Hintzen"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: rmarkdown:::pdf_document
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{kobe}
  \DeclareUnicodeCharacter{00A0}{ }
  %\VignetteEncoding{UTF-8}
#bibliography: /home/laurie/bib/refs.bib
tags: FLPKG FLR
license: Creative Commons Attribution-ShareAlike 4.0 International
---

```{r, eval=TRUE, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(knitr)

opts_chunk$set(comment=NA, 
               warning=FALSE, 
               message=FALSE, 
               error  =FALSE, 
               echo   =FALSE, 
               eval   =!TRUE,
               fig.width =4, 
               fig.height=4)

iFig=0
iTab=0
```

```{r init, eval=TRUE}
library(plyr)
library(ggplot2)
library(kobe)
library(reshape2)

load("D:/Repository/DGMARETuna/tutorials/advice_framework/data/yft.RData")
load("D:/Repository/DGMARETuna/tutorials/advice_framework/data/jjm.RData")


trk =transform(subset(yft,year%in%1970:2014),stock=stock,harvest=harvest)[,
                  c("year","Scenario","Method","stock","harvest")]
trk2=ddply(melt(trk,id=c("Scenario","Method","year")),.(variable,year,Method,Scenario),with, 
               median(value))
msy  =ddply(yft,.(Method,Scenario), with, c("bmsy"=bmsy[!is.na(bmsy)][1],"fmsy"=fmsy[!is.na(fmsy)][1]))

quads=rbind(data.frame(x=c(-Inf,-Inf,Inf,Inf), y=c(-Inf,  1,  1,-Inf), 
                         fill=as.factor("high")),
            data.frame(x=c(-Inf,-Inf,Inf,Inf), y=c(   1,Inf,Inf,   1), 
                         fill=as.factor("low")))
quad2=rbind(cbind(variable="stock",ddply(msy,.(Method,Scenario), 
                        transform, y=quads$y*bmsy,x=quads$x,fill=quads$fill)),
            cbind(variable="harvest",ddply(msy,.(Method,Scenario), 
                        transform, y=quads$y*fmsy,x=quads$x,fill=quads$fill)))[,-(4:5)]
```

# Day 1

| Day 1         |                                                           |
| --------------|:----------------------------------------------------------|
| 09:30 – 10:15 | **Presentation:** The advice framework                    |
| 10:15 – 10:45 | **Presentation:** Assessment: data needs                  |
| 10:45 – 11:00 | **Tea Break:**                                            |
| 11:00 – 12:15 | **Exercise:**                                             |
| 12:15 – 13:15 | **Lunch:**                                                |
| 13:15 – 14:30 | **Presentation:** Assessment: model assumptions           |
| 14:30 – 15:15 | **Exercise:**                                             |
| 15:15 – 15:30 | **Tea Break:**                                            |
| 15:30 – 16:30 | **Presentation:** Stock Status and Reference points       |
| 16:30 – 17:00 | **Summary of the day:**                                   |

In this course, we start at the end product: the advice. The advice contains a number topics and forms the foundation of the advice. From the advice sheet we jump back to start of the process, data, then following on with assessment models, how to relate stock status to reference points, how to prepare an outlook for a stock and finally how to design and evaluate management plans.


## The advice sheet (LAURIE)
Advice on many tuna species is provided on an annual basis. The advice sheets follow a standard format and can be vistited here:[Yellowfin tuna advice](https://www.iccat.int/Documents/SCRS/ExecSum/YFT_ENG.pdf)

If we go through the advice sheets, the following topics are discussed
1. Biology
2. History of catches
3. Indices
4. Stock status
5. Outlook / predictions
6. Basis of advice

All these topics are relevant because ...

[comment]: # (Now it is core that we follow the advice sheet and zoom in on each of the topics in what they mean, but we should not go in too much detail yet. I haven't seen an advice sheet myself so couldn't add the order. At this stage, I think we need to show what the core advice is, what the biological considerations are, what the reference points are and how that determines stock status and triggers a certain way of giving advice. In terms of showing kobe-plots, stick to rather simple concepts first, we'll get back to that later on in the course)


### The Kobe advice framework               

The provision of fisheries management advice requires the assessment of stock status relative to reference points, the prediction of the response of a stock to management, and checking that predictions are consistent with reality.

Elements of advice frameworks are

+ Management objectives
+ Target and limit reference points
+ Estimates of probability from stock assessments 
+ Harvest control rules 
+ Risk and uncertainty

### Management objectives

The original objective of the tRFMOs is to keep stocks at a level that will support MSY. It is no longer sufficient to just know where we are, however, we also need to know where we are headed and to assess the impact of uncertainty on our ability to meet management objectives. There is increasingly a need to consider a range of management objectives and the trade-offs between them, e.g. related to yield, safety and stability. It is also important that indicators do not overlap in what they tell us. Therefore to help implement the Precautionary Approach the tRFMOs have proposed limit reference points and are begining to simulation test Harvest Control Rules using MSE. 


### Stock Status

The data are for the last Yellowfin assessment where there were 4 methods and 2 scenarios related to choice of CPUEs. These will be used to illustrate the advice framework and uncertainty in parameter estimates, model assumptions and data

#### Stock synthesis and 1 set of CPUE indices

```{r, fig.width=6,fig.height=3, eval=TRUE}
names(msy)[3:4]=c("stock","harvest")
trk.rel=merge(trk2,melt(msy,id=c("Method","Scenario")),
          by=c("Method","Scenario","variable"))
trk.rel=transform(trk.rel,value=value*V1,
                  variable=ifelse(variable=="harvest","F/F[MSY]","B/B[MSY]"))[,-5]

ggplot(subset(trk.rel,Method=="SS"&Scenario==1))+
  geom_line(aes(year,value),col="brown",size=1.5)+
  facet_grid(variable~.,scale="free_y", labeller = label_parsed)+
  theme_bw(12)+theme(legend.position="none")+
  ylab("")+xlab("Year")
```

**Figure `r iFig=iFig+1; iFig`.** Absolute estimates


```{r, fig.width=6,fig.height=3, eval=TRUE}
quad2=transform(quad2,variable=ifelse(variable=="harvest","F/F[MSY]","B/B[MSY]"))

ggplot(subset(trk.rel,Method=="SS"&Scenario==1))+
  geom_polygon(aes(x,y,fill=fill),data=subset(quad2,Method=="SS"&Scenario==1)) +
  geom_line(aes(year,value),col="brown",size=1.5)+
  facet_grid(variable~.,scale="free_y")+
  scale_fill_manual(values=c("pink","lightgreen"), guide="none") +  
  facet_grid(variable~.,scale="free_y", labeller = label_parsed)+
  theme_bw(12)+theme(legend.position="none")+
  ylab("")+xlab("Year")
```

**Figure `r iFig=iFig+1; iFig`.** Estimates relative to reference points

## Kobe Phase Plot

```{r, eval=TRUE}
dat=ddply(subset(trk,Method=="SS"&Scenario==1&year<=2014),.(year),
          with, data.frame(stock=median(stock),harvest=median(harvest)))

p=kobePhase(dat)+
  geom_path( aes(stock,harvest),col="brown",size=.75)+
  geom_point(aes(stock,harvest),shape=21,fill="red",col="brown",size=1.0,
             data=subset(dat,year%in%seq(1950,2014,5)))+
    geom_point(aes(stock,harvest),shape=21,fill="red",col="brown",size=2.5,
             data=subset(dat,year==2014))
p
```


**Figure `r iFig=iFig+1; iFig`.** Phase plot

Estimates of probability from stock assessments 

```{r, eval=TRUE}
p+
  geom_point(aes(stock,harvest),shape=21,fill="red",col="brown",size=2.5,
             data=subset(yft,Method=="SS"&Scenario==1&year%in%2014))
```


**Figure `r iFig=iFig+1; iFig`.** Uncertainty in current estimates

#### Structual uncertainty

```{r, fig.height=3,fig.width=7, eval=TRUE}
ggplot(trk.rel)+
  geom_polygon(aes(x,y,fill=fill),data=quad2) +
  geom_line(aes(year,value,col=factor(Scenario)))+
  facet_grid(variable~Method,scale="free_y", labeller=label_parsed)+
  scale_fill_manual(values=c("pink","lightgreen"), guide="none") +  
  theme_bw()+theme(legend.position="none")+
  ylab(expression(""))+
  xlab("Year")
```

**Figure `r iFig=iFig+1; iFig`.** Estimates relative to reference points

[comment]: # (the figure below is becoming too much for the introduction, my suggestion is to stop here probably. To keep the code clean, let's delete it even if it's not printed to PDF)


```{r}
dat=ddply(subset(trk,year<=2014),.(Method,Scenario,year),
          with, data.frame(stock=median(stock),harvest=median(harvest)))

kobePhase(dat)+
  geom_path( aes(stock,harvest),col="brown",size=.75)+
  geom_point(aes(stock,harvest),shape=21,fill="red",col="brown",size=1.0)+
  facet_grid(Method~Scenario)
```

**Figure `r iFig=iFig+1; iFig`.** Phase plot


```{r}
kobePhase(subset(yft,year%in%2014))+
  geom_point(aes(stock,harvest),shape=21,fill="red",col="brown")+
  facet_grid(Method~Scenario)
```

**Figure `r iFig=iFig+1; iFig`.** Phase plot

 
```{r}
kobe:::kobePhaseMar3(transform(subset(yft,year%in%2014),run=paste(Method,Scenario)
                               )[,c("stock","harvest","run")])
```

**Figure `r iFig=iFig+1; iFig`.** Phase plot


```{r}
kobe:::kobePhaseMar2(transform(subset(yft,year%in%2014),run=paste(Method,Scenario)
                               )[,c("stock","harvest","run")])
```

**Figure `r iFig=iFig+1; iFig`.** Phase plot

## Projections 

**Figure `r iFig=iFig+1; iFig`.** Strategey matrix

**Figure `r iFig=iFig+1; iFig`.** Decision table


```{r}
hcr= data.frame(stock  =c(0.0 ,0.1 , 0.6,2.0), 
                harvest=c(0.01,0.01, 0.7,0.7))
kobePhase()+
  geom_line(aes(stock,harvest),data=hcr,col="orange",size=2)
```

```{r}
kobePhase(dat)+
  geom_point(aes(stock,harvest),shape=21,fill="red",col="brown",size=1.0)+
  geom_point(aes(stock,harvest),shape=21,fill="red",col="brown",size=1.0)+  
  geom_line(aes(stock,harvest),data=hcr,col="orange",size=2)
```


```{r}
kobePhase(dat)+
  geom_point(aes(stock,harvest),shape=21,fill="red",col="brown",size=1.0,)+
  geom_point(aes(stock,harvest),shape=21,fill="red",col="brown",size=1.0)+  
  geom_line(aes(stock,harvest),data=hcr,col="orange",size=1)+
  facet_grid(Method~Scenario)
```

Next I will
i) provide examples of projections based on these,
ii) do some hindcasting for validation
iii) project under a HCR

## Stock Assessment: data needs (NIELS)

To be able to provide fisheries advice, an estimation of stock size must be carried out. Here we focus on stock assessment models, models which often take fisheries dependent data and fisheries indepedent data to, combinedly, estimate how many fish are in the sea and how many can be caught sustainable.  

We'll be discussing:

* The types of data
    + Catch data
        + Age data / length data
    + Independent monitoring data
    + Dependent monitoring data
    + Biological data on maturity, natural mortality, weight
* Where to get this data from
    + Sampling of catch at sea or in harbour
    + Assumptions on maturity, natural mortality, weight
* Uncertainty in the data
    + Sampling design & accuracy
* Example from ICES (NIELS)
* Example from SPRFMO (NIELS)
* Example from ICCAT (LAURIE)

### Landings data

Landings data comprises all the fisheries catch that is brought into harbour / put on-land. Often it is only the marktable fish, but under the new landing obligation, it is also the smaller fish with limited value. In the end, the fish goes over the fish market, is kept in storage and sold via retailers or is sold directly to e.g. restaurant owners. 

![](http://www.nielshintzen.nl/Foto/Hawaii%20Oktober%202014/slides/NTH_8134.jpg)
**Figure `r iFig=iFig+1; iFig`.** Tuna at a fish market in Hawaii

Landings data is reported by the skipper in logbooks. These logbooks also contain information on the location of the catch, the catch position and details on the vessel such as horsepower of th engine and gear used to catch the fish. The information in these logbooks is reported to the autorities who collate all this information and send it on to fisheries scientists that prepare the data for stock assessment activities. The logbooks and declarations in harbour are also used to keep track of quota uptake, and the same autorities report back to skippers on how much quota is left. 

For stock assessment purposes, the landings data play a very important role. Often, it is the only reliable source of information. Getting the landings data correct is therefore crucial. If the landings data is of bad quality, one can usually assume that the stock assessment does not represent the real stock status very well. That has all to do with the way stock assessment models work, in a sense, they try to reconstruct the catch time-series assuming certain biological processes take place. 

```{r, fig.height=3,fig.width=7, eval=TRUE}
  dat <- rbind(data.frame(fleet=1,year=1970:2016,catch=jjm$output$Stock_1$Obs_catch_1),
               data.frame(fleet=2,year=1970:2016,catch=jjm$output$Stock_1$Obs_catch_2),  
               data.frame(fleet=3,year=1970:2016,catch=jjm$output$Stock_1$Obs_catch_3),  
               data.frame(fleet=4,year=1970:2016,catch=jjm$output$Stock_1$Obs_catch_4)) 

cols <- rep(c("black","red","green","blue"),each=47)

ggplot(data=dat,aes(x=year,y=catch,group=fleet))+
  geom_line(aes(colour=cols))+
  theme_bw()+theme(legend.position="none")+
  ylab(expression("Catch by fleet (Tonnes)"))+
  xlab("Year")
```
**Figure `r iFig=iFig+1; iFig`.** Fish catch from 1970 - 2016 for 4 different fleets.

#### Age data / length data

In addition to the landings data, age reading often takes place to proportion the total catch in age bins. This is crucial information if we want to track the same cohort of fish through the years and get an understanding of how they die of natural and fishing causes.

![](D:/Repository/DGMARETuna/tutorials/advice_framework/figures/figures09.png)
**Figure `r iFig=iFig+1; iFig`.** Proportional catch at age, coloured by cohort

In a number of fisheries however, ageing is too expensive or won't work because age reading relies on counting year-rings. In areas without any specific season (around the equator) year rings won't show up. In those cases, only length data are being used and, based on growth estimates, converted back to age.

![](D:/Repository/DGMARETuna/tutorials/advice_framework/figures/annuli-2-eng.jpg)
**Figure `r iFig=iFig+1; iFig`.** Otolith showing age-rings

### Independent monitoring data

A fisheries independent dataset is one collected by researchers in the field, often following a fixed design to get a representative view of the total stock biomass, recruitment or eggs produces. Although these series are relatively common in Europe, in Tuna and other RFMO's they are scarce. Independent monitoring data is expensive to collect and when a stock is widely distributed, the efforts needed to cover the entire stock are enourmous. They are however very useful for assessment purposes, which will be explain in more detail later on.

![](D:/Repository/DGMARETuna/tutorials/advice_framework/figures/HERAS.jpg)
**Figure `r iFig=iFig+1; iFig`.** Fisheries independent acoustic survey results versus the estimated stock size.

### Dependent monitoring data (CPUE)
Much more common in Tuna RFMOs is the use of Catch-Per-Unit-Effort data, because these data come straight from the fishing fleet. There is an assumption that whenever a fishing vessel catches more fish per unit of time, there is more fish in the sea. Although the CPUE data itself does not say how much fish there is, the change from year to year can be used as an indicator of changing biomass of fish all together. 

```{r, fig.height=3,fig.width=7, eval=TRUE}
dat <- rbind(data.frame(survey="Chinese_CPUE",year=jjm$output$Stock_1$Obs_Survey_6[,1],data=jjm$output$Stock_1$Obs_Survey_6[,2]/mean(jjm$output$Stock_1$Obs_Survey_6[,2])),
             data.frame(survey="EU_CPUE",year=jjm$output$Stock_1$Obs_Survey_7[,1],data=jjm$output$Stock_1$Obs_Survey_7[,2]/mean(jjm$output$Stock_1$Obs_Survey_7[,2])),
             data.frame(survey="Russian_CPUE",year=jjm$output$Stock_1$Obs_Survey_8[,1],data=jjm$output$Stock_1$Obs_Survey_8[,2]/mean(jjm$output$Stock_1$Obs_Survey_8[,2])),
             data.frame(survey="Chilean_CPUE",year=jjm$output$Stock_1$Obs_Survey_3[,1],data=jjm$output$Stock_1$Obs_Survey_3[,2]/mean(jjm$output$Stock_1$Obs_Survey_3[,2])))
             #data.frame(survey=5,year=jjm$output$Stock_1$Obs_Survey_5[,1],data=jjm$output$Stock_1$Obs_Survey_5[,2]/mean(jjm$output$Stock_1$Obs_Survey_5[,2])),
             #data.frame(survey=6,year=jjm$output$Stock_1$Obs_Survey_6[,1],data=jjm$output$Stock_1$Obs_Survey_6[,2]/mean(jjm$output$Stock_1$Obs_Survey_6[,2])),
             #data.frame(survey=7,year=jjm$output$Stock_1$Obs_Survey_7[,1],data=jjm$output$Stock_1$Obs_Survey_7[,2]/mean(jjm$output$Stock_1$Obs_Survey_7[,2])),
             #data.frame(survey=8,year=jjm$output$Stock_1$Obs_Survey_8[,1],data=jjm$output$Stock_1$Obs_Survey_8[,2]/mean(jjm$output$Stock_1$Obs_Survey_8[,2])),
             #data.frame(survey=9,year=jjm$output$Stock_1$Obs_Survey_9[,1],data=jjm$output$Stock_1$Obs_Survey_9[,2]/mean(jjm$output$Stock_1$Obs_Survey_9[,2])))


ggplot(data=dat,aes(x=year,y=data,group=survey))+
  geom_point()+geom_line()+
  facet_grid(.~survey)+
  ylab(expression("Index by fleet"))+
  xlab("Year")     

```


### Biological data
### Assumptions on maturity, natural mortality, weight

![](D:/Repository/DGMARETuna/tutorials/advice_framework/figures/figures12.png)
**Figure `r iFig=iFig+1; iFig`.** Estimated growth of a fish over age.

![](D:/Repository/DGMARETuna/tutorials/advice_framework/figures/figures13.png)
**Figure `r iFig=iFig+1; iFig`.** Estimated maturity over age.


### Example from the ICES world
### Example from the SPRFMO world
### Example from the ICCAT world

### **Exercise:**           



## Assessment: model assumptions (NIELS)  

The basics of an assessment model is to estimate, based on the removals by the fishery, how many fish are still left in the sea. 

* Two essential equations (NIELS)
    + Baranov catch equations
    + Survivor equation
* How do different datasets work together in an assessment model (NIELS)
* What do assessment models estimate (NIELS)
    + Fishing mortality
    + Selectivity
    + Stock numbers at age
    + Catchability
    + Residuals
    + Uncertainty in the parameters
* Where do they differ (LAURIE)
    + Age based assessments
    + Length based assessments
    + Bio-based assessments
    + Data-limted assessments
    + (LAURIE)
* Example from the ICCAT world (LAURIE)
* Example from the SPRFMO world (NIELS)

### Two essential equations
### How do different datasets work together
### What do assessment models estimate
### Where do they differ
#### biomass based
#### Age based

### **Exercise:**                                             
[comment]: #(Lets make a simple table with N, F, Maturity, M, etc and let them calculate SSB, Fbar, total biomass, survivors in the next year)

### Stock Status and Reference points (LAURIE)       

* Types of reference points used (LAURIE)
    + Fmsy, Bmsy, Bpa, Blim, B0, B40
* Bringing reference points into a policy context (LAURIE)
    + Kobe plot
* How to estimate reference points (NIELS)
    + SSB - Recruitment
    + Fmsy, Bmsy, Msy
    + Assumptions on selectivity & recruitment
* Difficulties with reference points (NIELS)
    + Changing biology
    + Mixed fisheries

\newpage
# Day 2

| Day 2         |                                                       |
| --------------|:------------------------------------------------------|
| 09:00 – 10:15 | **Presentation:** Projection scenario                 |
| 10:15 – 10:45 | **Exercise:**                                         |
| 10:45 – 11:00 | **Tea Break:**                                        |
| 11:00 – 12:15 | **Presentation:** Management Plans                    |
| 12:15 – 13:15 | **Lunch:**                                            |
| 13:15 – 14:00 | **Exercise:**                                         |
| 14:00 – 16:00 | **Summary of the day**                                |


## Projection scenarios (LAURIE) 

* Purpose of projections (LAURIE)
* Assumptions in projections (LAURIE)
    + Recruitment 
    + Productivity
    + Selectivity
    + Model assumption
    + Expected outtake in year before TAC year
* Aim in projections (NIELS)
    + Specific TAC
    + Specific SSB or F
* Example from ICEs (NIELS)
* Example from SPRFMO (NIELS)
* Example from ICCAT (LAURIE)


### **Exercise:**  

## Management Plans (Let's decide)

* Generic design of a management plan
* How to evaluate a management plan
    + Management Plan Evaluation (MSE)
        + Operating model
        + Fleet model
        + Assessment model
        + Advisory framework
* Criteria in a management plan
    + Precaution
    + MSY
    + Being on target
    + Stable yield
* Assumptions and validity
    + Recruitment & selectivity
    + Medium term to long term evaluations
    + Implementation error
* Example from ICCAT (LAURIE)
* Example from SPRFMO (NIELS)

### **Exercise:**                                             

[comment]: #(Not sure what this below is doing, but I guess you want to lift this in the doc somewhere

http://rscloud.iccat.int:3838/swo-med-xsa/

## Data
## Model assumptions
## Diagnostics
## Reliablity
## Stock status wrt reference points

## Projections
http://rscloud.iccat.int:3838/swo-med/

Prediction is often used synonymously citep{bray2009prediction} with forecast, projection and scenario. To avoid confusion we base our definitions on those of the International Panel on Climate Change  citep[IPCC][]{field2012managing}. A projection is a potential future evolution of a quantity or set of quantities, a prediction or forecast is the result of an attempt to produce an estimate of the actual evolution of the future, while a scenario is a possible, plausible, internally consistent, but not necessarily probable, development.)
